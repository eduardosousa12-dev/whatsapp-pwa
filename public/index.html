<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ZapZap">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <title>ZapZap</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --glass: rgba(255,255,255,0.03);
            --glass-border: rgba(255,255,255,0.08);
            --accent: #00d48a;
            --accent-glow: rgba(0, 212, 138, 0.3);
            --accent-gradient: linear-gradient(135deg, #00a884, #00d48a);
            --text-primary: #ffffff;
            --text-secondary: #8892a0;
            --text-muted: #5a6270;
            --danger: #ff4757;
            --purple: #a855f7;
            --blue: #3b82f6;
            --orange: #f97316;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        .screen { display: none; flex-direction: column; height: 100%; }
        .screen.active { display: flex; }

        /* === ACCOUNTS SCREEN === */
        .accounts-screen {
            padding: 20px;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, var(--bg-primary) 70%);
        }
        .accounts-header {
            text-align: center;
            padding: 40px 0 30px;
        }
        .accounts-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: var(--accent-gradient);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 40px var(--accent-glow);
        }
        .accounts-logo svg { fill: white; width: 40px; height: 40px; }
        .accounts-title {
            font-size: 28px;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .accounts-subtitle { color: var(--text-secondary); font-size: 14px; }

        .accounts-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        .account-item {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 14px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .account-item:hover { background: var(--bg-tertiary); }
        .account-item:active { transform: scale(0.98); }

        .account-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--purple), var(--blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }
        .account-info { flex: 1; }
        .account-name { font-size: 16px; font-weight: 500; margin-bottom: 4px; }
        .account-phone { font-size: 13px; color: var(--text-secondary); }
        .account-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .account-status.connected { background: rgba(0,212,138,0.2); color: var(--accent); }
        .account-status.disconnected { background: rgba(255,71,87,0.2); color: var(--danger); }

        .account-delete {
            width: 36px;
            height: 36px;
            background: rgba(255,71,87,0.1);
            border: none;
            border-radius: 50%;
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }
        .account-delete:hover { background: var(--danger); color: white; }

        .add-account-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 8px 30px var(--accent-glow);
            transition: all 0.2s;
            margin-top: 16px;
        }
        .add-account-btn:hover { transform: translateY(-2px); }

        /* === QR SCREEN === */
        .qr-screen {
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, var(--bg-primary) 70%);
        }
        .qr-back {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .qr-back:hover { color: var(--text-primary); }

        .qr-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            background: var(--accent-gradient);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 40px var(--accent-glow);
        }
        .qr-logo svg { fill: white; width: 40px; height: 40px; }
        .qr-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .qr-subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }

        .qr-container {
            background: white;
            padding: 16px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .qr-container img { width: 200px; height: 200px; border-radius: 12px; }
        .qr-loading { width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0,212,138,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .status-text { color: var(--text-secondary); font-size: 14px; }

        /* === APP === */
        .app { position: relative; background: var(--bg-primary); }

        .header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            min-height: 64px;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }
        .header-back {
            display: none;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }
        .header-back.show { display: block; }
        .header-avatar {
            width: 44px;
            height: 44px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 18px;
            font-weight: 600;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid var(--accent);
            cursor: pointer;
        }
        .header-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .header-info { flex: 1; }
        .header-title { font-size: 17px; font-weight: 600; }
        .header-status { color: var(--accent); font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .header-status::before { content: ''; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; }
        .header-menu {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
        }

        .chat-list { flex: 1; overflow-y: auto; padding: 8px; }
        .chat-list.hidden { display: none; }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            gap: 14px;
            cursor: pointer;
            border-radius: 16px;
            margin-bottom: 4px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .chat-item:hover { background: var(--glass); border-color: var(--glass-border); }

        .chat-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 600;
            flex-shrink: 0;
            overflow: hidden;
        }
        .chat-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .chat-content { flex: 1; min-width: 0; }
        .chat-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .chat-name { font-size: 16px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-time { color: var(--text-muted); font-size: 12px; }
        .chat-preview { display: flex; justify-content: space-between; }
        .chat-message { color: var(--text-secondary); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .chat-badge {
            background: var(--accent-gradient);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
            padding: 40px;
        }

        .fab {
            position: absolute;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 30px var(--accent-glow);
            z-index: 20;
        }
        .fab svg { fill: white; width: 26px; height: 26px; }
        .fab.hidden { display: none; }

        .messages-view { display: none; flex-direction: column; flex: 1; min-height: 0; overflow: hidden; }
        .messages-view.active { display: flex; }

        .messages-header {
            display: flex;
            padding: 10px 16px;
            background: var(--glass);
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }
        .history-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            color: var(--accent);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            margin-bottom: 8px;
        }
        .message.received {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .message.sent {
            background: var(--accent-gradient);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .message-text { font-size: 15px; line-height: 1.5; }
        .message-time { font-size: 11px; opacity: 0.7; text-align: right; margin-top: 4px; }
        .message-sender { font-size: 12px; color: var(--accent); margin-bottom: 4px; font-weight: 600; }
        .message-media { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 4px; }
        .message-media-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .message-media-icon svg { fill: white; width: 18px; height: 18px; }

        .input-area {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--glass);
            gap: 10px;
            flex-shrink: 0;
            border-top: 1px solid var(--glass-border);
        }
        .attach-btn {
            width: 44px;
            height: 44px;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .attach-btn svg { fill: var(--text-secondary); width: 22px; height: 22px; }
        .message-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 14px 20px;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
        }
        .message-input:focus { border-color: var(--accent); }
        .message-input::placeholder { color: var(--text-muted); }
        .send-btn, .mic-btn {
            width: 48px;
            height: 48px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        .send-btn svg, .mic-btn svg { fill: white; width: 22px; height: 22px; }

        .mic-btn.recording { background: linear-gradient(135deg, #ff4757, #ff6b7a); animation: pulse 1s infinite; }
        @keyframes pulse { 50% { transform: scale(1.1); } }

        .recording-indicator { display: none; align-items: center; gap: 10px; flex: 1; padding: 0 16px; }
        .recording-indicator.show { display: flex; }
        .cancel-recording-btn { width: 36px; height: 36px; background: var(--danger); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .recording-dot { width: 14px; height: 14px; background: var(--danger); border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
        .recording-time { font-size: 16px; font-weight: 600; }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 70px;
            right: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 100;
            min-width: 200px;
            overflow: hidden;
        }
        .menu-dropdown.show { display: block; }
        .menu-item { padding: 16px 20px; cursor: pointer; transition: background 0.2s; }
        .menu-item:hover { background: var(--glass); }
        .menu-item.danger { color: var(--danger); }

        .attach-menu {
            display: none;
            position: absolute;
            bottom: 80px;
            left: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 100;
            padding: 12px 0;
        }
        .attach-menu.show { display: block; }
        .attach-option { display: flex; align-items: center; gap: 14px; padding: 14px 24px; cursor: pointer; }
        .attach-option:hover { background: var(--glass); }
        .attach-option-icon { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .attach-option-icon.camera { background: linear-gradient(135deg, #10b981, #34d399); }
        .attach-option-icon.image { background: linear-gradient(135deg, #a855f7, #c084fc); }
        .attach-option-icon.audio { background: linear-gradient(135deg, #f97316, #fb923c); }
        .attach-option-icon.document { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
        .attach-option-icon svg { fill: white; width: 20px; height: 20px; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            width: 100%;
            max-width: 380px;
            overflow: hidden;
        }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--glass-border); background: var(--glass); }
        .modal-title { font-size: 20px; font-weight: 600; }
        .modal-body { padding: 24px; }
        .modal-input {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 16px 18px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            margin-bottom: 16px;
        }
        .modal-input:focus { border-color: var(--accent); }
        .modal-label { color: var(--text-secondary); font-size: 13px; margin-bottom: 8px; display: block; }
        .modal-select { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--glass-border); border-radius: 14px; padding: 16px; color: var(--text-primary); font-size: 16px; margin-bottom: 16px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 20px 24px; border-top: 1px solid var(--glass-border); background: var(--glass); }
        .modal-btn { padding: 12px 28px; border-radius: 50px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; }
        .modal-btn.cancel { background: var(--bg-tertiary); color: var(--text-secondary); }
        .modal-btn.primary { background: var(--accent-gradient); color: white; }

        .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 50; }
        .overlay.show { display: block; }

        .preview-container {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 16px;
            z-index: 100;
        }
        .preview-container.show { display: block; }
        .preview-image { max-width: 100%; max-height: 200px; border-radius: 12px; margin-bottom: 12px; }
        .preview-close { position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; background: var(--danger); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        .hidden-input { display: none; }

        .audio-player { background: rgba(0,0,0,0.1); border-radius: 20px; }
        .audio-player input[type="range"] { -webkit-appearance: none; height: 4px; border-radius: 2px; outline: none; }
        .audio-player input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: white; cursor: pointer; }
    </style>
</head>
<body>
    <!-- ACCOUNTS SCREEN -->
    <div class="screen accounts-screen active" id="accountsScreen">
        <div class="accounts-header">
            <div class="accounts-logo"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></div>
            <h1 class="accounts-title">ZapZap</h1>
            <p class="accounts-subtitle">Gerencie v√°rias contas WhatsApp</p>
        </div>
        <div class="accounts-list" id="accountsList">
            <div class="empty-state" id="noAccounts">
                <p>Nenhuma conta ainda</p>
                <p style="font-size:13px;margin-top:8px;opacity:0.7;">Adicione sua primeira conta WhatsApp</p>
            </div>
        </div>
        <button class="add-account-btn" id="addAccountBtn">+ Adicionar Conta</button>
    </div>

    <!-- QR SCREEN -->
    <div class="screen qr-screen" id="qrScreen">
        <button class="qr-back" id="qrBackBtn">‚Üê</button>
        <div class="qr-logo"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></div>
        <h2 class="qr-title" id="qrAccountName">Conectar Conta</h2>
        <p class="qr-subtitle">Escaneie o QR Code com seu WhatsApp</p>
        <div class="qr-container" id="qrContainer"><div class="qr-loading"><div class="spinner"></div></div></div>
        <p class="status-text" id="statusText">Aguardando QR Code...</p>
    </div>

    <!-- APP SCREEN -->
    <div class="screen app" id="app">
        <header class="header">
            <button class="header-back" id="backBtn">‚Üê</button>
            <div class="header-avatar" id="headerAvatar"><svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
            <div class="header-info">
                <div class="header-title" id="headerTitle">Conversas</div>
                <div class="header-status" id="headerStatus">Online</div>
            </div>
            <button class="header-menu" id="menuBtn">‚ãÆ</button>
        </header>

        <div class="overlay" id="overlay"></div>
        <div class="menu-dropdown" id="menuDropdown">
            <div class="menu-item" id="switchAccountBtn">üîÑ Trocar conta</div>
            <div class="menu-item" id="refreshChats">üì• Atualizar conversas</div>
            <div class="menu-item danger" id="logoutBtn">üö™ Desconectar conta</div>
        </div>

        <div class="chat-list" id="chatList">
            <div class="empty-state" id="emptyState">
                <p>Nenhuma conversa ainda</p>
                <p style="font-size:13px;margin-top:8px;opacity:0.7;">Toque no + para iniciar</p>
            </div>
        </div>

        <button class="fab" id="fabBtn"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>

        <div class="messages-view" id="messagesView">
            <div class="messages-header"><button class="history-btn" id="historyBtn">üìÖ Carregar mais</button></div>
            <div class="messages-container" id="messagesContainer"></div>

            <div class="attach-menu" id="attachMenu">
                <div class="attach-option" id="attachCamera"><div class="attach-option-icon camera"><svg viewBox="0 0 24 24"><path d="M12 15.2c1.78 0 3.2-1.42 3.2-3.2S13.78 8.8 12 8.8 8.8 10.22 8.8 12s1.42 3.2 3.2 3.2zm8-6.4h-2.4l-1.6-2H8l-1.6 2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-10c0-1.1-.9-2-2-2z"/></svg></div><span>C√¢mera</span></div>
                <div class="attach-option" id="attachImage"><div class="attach-option-icon image"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div><span>Galeria</span></div>
                <div class="attach-option" id="attachAudio"><div class="attach-option-icon audio"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/></svg></div><span>√Åudio</span></div>
                <div class="attach-option" id="attachDocument"><div class="attach-option-icon document"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/></svg></div><span>Documento</span></div>
            </div>

            <div class="preview-container" id="previewContainer">
                <button class="preview-close" id="previewClose">√ó</button>
                <div id="previewContent"></div>
            </div>

            <div class="input-area">
                <button class="attach-btn" id="attachBtn"><svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg></button>
                <div class="recording-indicator" id="recordingIndicator">
                    <button class="cancel-recording-btn" id="cancelRecordingBtn">‚úï</button>
                    <div class="recording-dot"></div>
                    <span class="recording-time" id="recordingTime">0:00</span>
                    <span style="color:var(--text-muted);font-size:13px;">Gravando...</span>
                </div>
                <input type="text" class="message-input" id="messageInput" placeholder="Digite sua mensagem...">
                <button class="send-btn" id="sendBtn"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                <button class="mic-btn" id="micBtn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/></svg></button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="newAccountModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title">Nova Conta</div></div>
            <div class="modal-body">
                <label class="modal-label">Nome da conta</label>
                <input type="text" class="modal-input" id="accountNameInput" placeholder="Ex: Pessoal, Trabalho...">
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="newAccountCancel">Cancelar</button>
                <button class="modal-btn primary" id="newAccountConfirm">Criar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="newChatModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title">Nova conversa</div></div>
            <div class="modal-body">
                <label class="modal-label">N√∫mero (com DDD)</label>
                <input type="tel" class="modal-input" id="phoneInput" placeholder="11999999999">
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="newChatCancel">Cancelar</button>
                <button class="modal-btn primary" id="newChatConfirm">Iniciar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title">Carregar hist√≥rico</div></div>
            <div class="modal-body">
                <label class="modal-label">Per√≠odo</label>
                <select class="modal-select" id="historyPeriod">
                    <option value="7">7 dias</option>
                    <option value="30">30 dias</option>
                    <option value="90">3 meses</option>
                </select>
                <label class="modal-label">Limite</label>
                <select class="modal-select" id="historyLimit">
                    <option value="50">50 mensagens</option>
                    <option value="100">100 mensagens</option>
                    <option value="200">200 mensagens</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="historyCancel">Cancelar</button>
                <button class="modal-btn primary" id="historyConfirm">Carregar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="profileModal">
        <div class="modal" style="max-width:340px;">
            <div class="modal-body" style="text-align:center;padding:32px 24px;">
                <div id="profileAvatar" style="width:100px;height:100px;margin:0 auto 16px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--blue));display:flex;align-items:center;justify-content:center;font-size:40px;color:white;overflow:hidden;"></div>
                <h2 id="profileName" style="font-size:22px;margin-bottom:4px;"></h2>
                <p id="profileNumber" style="color:var(--text-secondary);margin-bottom:20px;"></p>
                <div style="display:flex;gap:12px;justify-content:center;">
                    <button class="modal-btn primary" id="profileCopy">Copiar n√∫mero</button>
                    <button class="modal-btn cancel" id="profileClose">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" class="hidden-input" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" class="hidden-input" id="imageInput" accept="image/*">
    <input type="file" class="hidden-input" id="audioInput" accept="audio/*">
    <input type="file" class="hidden-input" id="documentInput" accept="*/*">

    <script>
        const $ = id => document.getElementById(id);

        // State
        let socket;
        let accounts = [];
        let currentAccountId = null;
        let currentChat = null;
        let chats = [];
        let pendingMedia = null;
        let currentContactInfo = null;
        let mediaRecorder = null, audioChunks = [], isRecording = false, recordingTimer = null, recordingSeconds = 0;

        // Elements
        const accountsScreen = $('accountsScreen'), accountsList = $('accountsList'), noAccounts = $('noAccounts');
        const qrScreen = $('qrScreen'), qrContainer = $('qrContainer'), statusText = $('statusText'), qrAccountName = $('qrAccountName');
        const app = $('app'), chatList = $('chatList'), emptyState = $('emptyState'), messagesView = $('messagesView');
        const messagesContainer = $('messagesContainer'), messageInput = $('messageInput');
        const headerTitle = $('headerTitle'), headerStatus = $('headerStatus'), headerAvatar = $('headerAvatar');

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }

        function init() {
            socket = io();

            socket.on('accounts-update', (accs) => {
                accounts = accs;
                renderAccounts();
            });

            socket.on('account-qr', ({ accountId, qr }) => {
                if (currentAccountId === accountId) {
                    qrContainer.innerHTML = `<img src="${qr}">`;
                    statusText.textContent = 'Escaneie o QR Code';
                }
            });

            socket.on('account-status', ({ accountId, status, message }) => {
                if (currentAccountId === accountId) {
                    statusText.textContent = message;
                    if (status === 'connected') {
                        showScreen(app);
                        headerStatus.textContent = 'Online';
                    }
                }
            });

            socket.on('chats-update', ({ accountId, chats: c }) => {
                if (currentAccountId === accountId) {
                    chats = c;
                    renderChats();
                }
            });

            socket.on('new-message', ({ accountId, jid, message }) => {
                if (currentAccountId === accountId && currentChat === jid) {
                    appendMessage(message);
                }
            });

            socket.on('messages', ({ accountId, jid, messages, profilePic }) => {
                if (currentAccountId === accountId && currentChat === jid) {
                    renderMessages(messages);
                    if (profilePic) headerAvatar.innerHTML = `<img src="${profilePic}">`;
                }
            });

            socket.on('history', ({ accountId, jid, messages, total }) => {
                if (currentAccountId === accountId && currentChat === jid) {
                    renderMessages(messages);
                    headerStatus.textContent = `${total} mensagens`;
                }
                $('historyModal').classList.remove('show');
            });

            socket.on('message-sent', ({ accountId, jid, message }) => {
                if (currentAccountId === accountId && currentChat === jid) {
                    if (pendingMedia && (message.type === 'audio' || message.type === 'image')) {
                        message.mediaData = pendingMedia.data;
                        message.mediaMimetype = pendingMedia.mimetype;
                    }
                    appendMessage(message);
                }
                messageInput.value = '';
                pendingMedia = null;
                $('previewContainer').classList.remove('show');
            });

            socket.on('new-chat-ready', ({ accountId, jid, name, profilePic }) => {
                if (currentAccountId === accountId) {
                    $('newChatModal').classList.remove('show');
                    $('phoneInput').value = '';
                    openChat(jid, name, profilePic);
                }
            });

            socket.on('account-created', ({ accountId, name }) => {
                currentAccountId = accountId;
                qrAccountName.textContent = name;
                qrContainer.innerHTML = '<div class="qr-loading"><div class="spinner"></div></div>';
                statusText.textContent = 'Conectando...';
                showScreen(qrScreen);
                socket.emit('connect-account', { accountId });
            });

            socket.on('error', ({ message }) => alert(message));
        }

        function renderAccounts() {
            if (accounts.length === 0) {
                noAccounts.style.display = 'flex';
                accountsList.innerHTML = '';
                accountsList.appendChild(noAccounts);
                return;
            }
            noAccounts.style.display = 'none';
            const colors = ['#a855f7', '#3b82f6', '#10b981', '#f97316', '#ef4444'];
            accountsList.innerHTML = accounts.map((acc, i) => {
                const color = colors[i % colors.length];
                const statusClass = acc.connectionState === 'connected' ? 'connected' : 'disconnected';
                const statusText = acc.connectionState === 'connected' ? 'Conectado' : 'Desconectado';
                const phone = acc.phoneNumber ? `+${acc.phoneNumber}` : 'N√£o conectado';
                return `<div class="account-item" data-id="${acc.id}">
                    <div class="account-avatar" style="background:linear-gradient(135deg,${color},${color}aa)">${acc.name.charAt(0).toUpperCase()}</div>
                    <div class="account-info">
                        <div class="account-name">${escapeHtml(acc.name)}</div>
                        <div class="account-phone">${phone}</div>
                    </div>
                    <span class="account-status ${statusClass}">${statusText}</span>
                    <button class="account-delete" data-id="${acc.id}" onclick="event.stopPropagation();deleteAccount('${acc.id}')">√ó</button>
                </div>`;
            }).join('');

            document.querySelectorAll('.account-item').forEach(item => {
                item.addEventListener('click', () => selectAccount(item.dataset.id));
            });
        }

        function selectAccount(accountId) {
            currentAccountId = accountId;
            const acc = accounts.find(a => a.id === accountId);
            if (!acc) return;

            if (acc.connectionState === 'connected') {
                showScreen(app);
                headerTitle.textContent = acc.name;
                socket.emit('get-account-state', { accountId });
            } else {
                qrAccountName.textContent = acc.name;
                qrContainer.innerHTML = '<div class="qr-loading"><div class="spinner"></div></div>';
                statusText.textContent = 'Conectando...';
                showScreen(qrScreen);
                socket.emit('connect-account', { accountId });
            }
        }

        function deleteAccount(accountId) {
            if (confirm('Deletar esta conta?')) {
                socket.emit('delete-account', { accountId });
            }
        }

        function renderChats() {
            if (chats.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }
            emptyState.style.display = 'none';
            const colors = ['#a855f7', '#3b82f6', '#10b981', '#f97316', '#ef4444'];
            chatList.innerHTML = chats.map((chat, i) => {
                const name = chat.name || chat.id.split('@')[0];
                const lastMsg = chat.lastMessage?.text || '';
                const time = chat.timestamp ? formatTime(chat.timestamp) : '';
                const unread = chat.unreadCount || 0;
                const color = colors[i % colors.length];
                return `<div class="chat-item" data-jid="${chat.id}" data-name="${escapeHtml(name)}" data-pic="${chat.profilePic || ''}">
                    <div class="chat-avatar" style="background:linear-gradient(135deg,${color},${color}aa)">${chat.profilePic ? `<img src="${chat.profilePic}">` : name.charAt(0).toUpperCase()}</div>
                    <div class="chat-content">
                        <div class="chat-header"><span class="chat-name">${escapeHtml(name)}</span><span class="chat-time">${time}</span></div>
                        <div class="chat-preview"><span class="chat-message">${escapeHtml(lastMsg)}</span>${unread > 0 ? `<span class="chat-badge">${unread}</span>` : ''}</div>
                    </div>
                </div>`;
            }).join('') + '<div class="empty-state" style="display:none;"></div>';
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', () => openChat(item.dataset.jid, item.dataset.name, item.dataset.pic));
            });
        }

        function openChat(jid, name, profilePic) {
            currentChat = jid;
            const displayName = name || jid.split('@')[0];
            const phoneNumber = jid.split('@')[0];
            currentContactInfo = { jid, name: displayName, profilePic, phoneNumber };
            headerTitle.textContent = displayName;
            headerStatus.textContent = 'Carregando...';
            headerAvatar.innerHTML = profilePic ? `<img src="${profilePic}">` : displayName.charAt(0).toUpperCase();
            $('backBtn').classList.add('show');
            $('fabBtn').classList.add('hidden');
            chatList.classList.add('hidden');
            messagesView.classList.add('active');
            messagesContainer.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Carregando...</div>';
            socket.emit('get-messages', { accountId: currentAccountId, jid });
        }

        function closeChat() {
            currentChat = null;
            const acc = accounts.find(a => a.id === currentAccountId);
            headerTitle.textContent = acc?.name || 'Conversas';
            headerStatus.textContent = 'Online';
            headerAvatar.innerHTML = '<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
            $('backBtn').classList.remove('show');
            $('fabBtn').classList.remove('hidden');
            chatList.classList.remove('hidden');
            messagesView.classList.remove('active');
            pendingMedia = null;
            $('previewContainer').classList.remove('show');
            $('attachMenu').classList.remove('show');
        }

        function renderMessages(messages) {
            headerStatus.textContent = `${messages.length} mensagens`;
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Nenhuma mensagem</div>';
                return;
            }
            messagesContainer.innerHTML = messages.map(msg => createMessageHtml(msg)).join('');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function appendMessage(msg) {
            const empty = messagesContainer.querySelector('div[style*="text-align:center"]');
            if (empty) empty.remove();
            messagesContainer.insertAdjacentHTML('beforeend', createMessageHtml(msg));
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function createMessageHtml(msg) {
            const cls = msg.fromMe ? 'sent' : 'received';
            const time = formatTime(msg.timestamp);
            const sender = !msg.fromMe && msg.pushName ? `<div class="message-sender">${escapeHtml(msg.pushName)}</div>` : '';
            let content = '';

            if (msg.type === 'image') {
                if (msg.mediaData) {
                    content = `<div class="message-media" style="flex-direction:column;"><img src="data:${msg.mediaMimetype || 'image/jpeg'};base64,${msg.mediaData}" style="max-width:250px;max-height:300px;border-radius:8px;cursor:pointer;" onclick="window.open(this.src,'_blank')">${msg.text ? `<span style="margin-top:8px;">${escapeHtml(msg.text)}</span>` : ''}</div>`;
                } else {
                    content = `<div class="message-media"><div class="message-media-icon"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div><span>Imagem</span></div>`;
                }
            } else if (msg.type === 'audio') {
                if (msg.mediaData) {
                    const audioId = 'audio_' + msg.id;
                    content = `<div class="audio-player" style="display:flex;align-items:center;gap:10px;padding:8px 12px;min-width:240px;">
                        <button onclick="toggleAudio('${audioId}')" style="width:36px;height:36px;border-radius:50%;border:none;background:${msg.fromMe ? 'rgba(255,255,255,0.2)' : 'var(--accent)'};cursor:pointer;display:flex;align-items:center;justify-content:center;">
                            <svg id="icon_${audioId}" viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <div style="flex:1;display:flex;flex-direction:column;gap:4px;">
                            <input type="range" id="progress_${audioId}" value="0" min="0" max="100" style="width:100%;background:${msg.fromMe ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.2)'};" oninput="seekAudio('${audioId}',this.value)">
                            <span id="time_${audioId}" style="font-size:11px;opacity:0.7;">0:00</span>
                        </div>
                        <audio id="${audioId}" src="data:${msg.mediaMimetype || 'audio/ogg'};base64,${msg.mediaData}" preload="metadata" ontimeupdate="updateProgress('${audioId}')" onended="resetAudio('${audioId}')" onloadedmetadata="setDuration('${audioId}')"></audio>
                    </div>`;
                } else {
                    content = `<div class="message-media"><div class="message-media-icon"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/></svg></div><span>√Åudio</span></div>`;
                }
            } else if (msg.type === 'document') {
                content = `<div class="message-media"><div class="message-media-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/></svg></div><span>${escapeHtml(msg.text)}</span></div>`;
            } else if (msg.type === 'video') {
                content = `<div class="message-media"><div class="message-media-icon"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></div><span>V√≠deo</span></div>`;
            } else {
                content = `<div class="message-text">${escapeHtml(msg.text)}</div>`;
            }

            return `<div class="message ${cls}">${sender}${content}<div class="message-time">${time}</div></div>`;
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (pendingMedia) {
                socket.emit('send-message', { accountId: currentAccountId, jid: currentChat, text, type: pendingMedia.type, media: pendingMedia.data, fileName: pendingMedia.fileName, mimetype: pendingMedia.mimetype });
            } else if (text && currentChat) {
                socket.emit('send-message', { accountId: currentAccountId, jid: currentChat, text, type: 'text' });
            }
        }

        async function handleFileSelect(file, type) {
            try {
                let fileToProcess = file;
                if (type === 'image' && file.size > 500 * 1024) {
                    fileToProcess = await compressImage(file);
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    pendingMedia = { type, data: e.target.result.split(',')[1], fileName: fileToProcess.name, mimetype: fileToProcess.type };
                    $('previewContent').innerHTML = type === 'image' ? `<img class="preview-image" src="${e.target.result}">` : `<div style="padding:20px;color:var(--text-primary);">${fileToProcess.name}</div>`;
                    $('previewContainer').classList.add('show');
                    $('attachMenu').classList.remove('show');
                };
                reader.readAsDataURL(fileToProcess);
            } catch (err) {
                alert('Erro: ' + err.message);
            }
        }

        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    let w = img.width, h = img.height;
                    if (w > 1920) { h = (1920 / w) * h; w = 1920; }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(blob => blob ? resolve(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' })) : reject(new Error('Falha')), 'image/jpeg', 0.8);
                };
                img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Erro')); };
                img.src = url;
            });
        }

        function formatTime(ts) {
            if (!ts) return '';
            let timestamp = typeof ts === 'object' && ts.low !== undefined ? ts.low : ts;
            const d = new Date(timestamp * 1000);
            if (isNaN(d.getTime())) return '';
            const now = new Date();
            return d.toDateString() === now.toDateString() ? d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        // Audio controls
        function toggleAudio(id) {
            const audio = $(id), icon = $('icon_' + id);
            if (!audio) return;
            document.querySelectorAll('audio').forEach(a => { if (a.id !== id && !a.paused) { a.pause(); const i = $('icon_' + a.id); if (i) i.innerHTML = '<path d="M8 5v14l11-7z"/>'; } });
            if (audio.paused) { audio.play(); icon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; }
            else { audio.pause(); icon.innerHTML = '<path d="M8 5v14l11-7z"/>'; }
        }
        function updateProgress(id) {
            const audio = $(id), progress = $('progress_' + id), time = $('time_' + id);
            if (!audio || !progress) return;
            progress.value = (audio.currentTime / audio.duration) * 100 || 0;
            const m = Math.floor(audio.currentTime / 60), s = Math.floor(audio.currentTime % 60);
            time.textContent = `${m}:${s.toString().padStart(2, '0')}`;
        }
        function seekAudio(id, val) { const audio = $(id); if (audio?.duration) audio.currentTime = (val / 100) * audio.duration; }
        function resetAudio(id) {
            const icon = $('icon_' + id), progress = $('progress_' + id), time = $('time_' + id);
            if (icon) icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            if (progress) progress.value = 0;
            if (time) time.textContent = '0:00';
        }
        function setDuration(id) {
            const audio = $(id), time = $('time_' + id);
            if (!audio?.duration || !isFinite(audio.duration)) return;
            const m = Math.floor(audio.duration / 60), s = Math.floor(audio.duration % 60);
            time.textContent = `${m}:${s.toString().padStart(2, '0')}`;
        }

        // Event listeners
        $('addAccountBtn').addEventListener('click', () => $('newAccountModal').classList.add('show'));
        $('newAccountCancel').addEventListener('click', () => { $('newAccountModal').classList.remove('show'); $('accountNameInput').value = ''; });
        $('newAccountConfirm').addEventListener('click', () => {
            const name = $('accountNameInput').value.trim() || 'Nova Conta';
            socket.emit('create-account', { name });
            $('newAccountModal').classList.remove('show');
            $('accountNameInput').value = '';
        });

        $('qrBackBtn').addEventListener('click', () => showScreen(accountsScreen));
        $('backBtn').addEventListener('click', closeChat);
        $('switchAccountBtn').addEventListener('click', () => { $('menuDropdown').classList.remove('show'); $('overlay').classList.remove('show'); showScreen(accountsScreen); });
        $('menuBtn').addEventListener('click', () => { $('menuDropdown').classList.toggle('show'); $('overlay').classList.toggle('show'); });
        $('overlay').addEventListener('click', () => { $('menuDropdown').classList.remove('show'); $('overlay').classList.remove('show'); });
        $('refreshChats').addEventListener('click', () => { socket.emit('get-account-state', { accountId: currentAccountId }); $('menuDropdown').classList.remove('show'); $('overlay').classList.remove('show'); });
        $('logoutBtn').addEventListener('click', () => { if (confirm('Desconectar esta conta?')) { socket.emit('logout-account', { accountId: currentAccountId }); $('menuDropdown').classList.remove('show'); $('overlay').classList.remove('show'); showScreen(accountsScreen); } });

        $('fabBtn').addEventListener('click', () => $('newChatModal').classList.add('show'));
        $('newChatCancel').addEventListener('click', () => { $('newChatModal').classList.remove('show'); $('phoneInput').value = ''; });
        $('newChatConfirm').addEventListener('click', () => { const p = $('phoneInput').value.trim(); if (p) socket.emit('start-new-chat', { accountId: currentAccountId, phoneNumber: p }); });

        $('sendBtn').addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });

        $('historyBtn').addEventListener('click', () => $('historyModal').classList.add('show'));
        $('historyCancel').addEventListener('click', () => $('historyModal').classList.remove('show'));
        $('historyConfirm').addEventListener('click', () => {
            socket.emit('get-history', { accountId: currentAccountId, jid: currentChat, days: parseInt($('historyPeriod').value), limit: parseInt($('historyLimit').value) });
            $('historyModal').classList.remove('show');
        });

        $('attachBtn').addEventListener('click', () => $('attachMenu').classList.toggle('show'));
        $('attachCamera').addEventListener('click', () => { $('cameraInput').click(); $('attachMenu').classList.remove('show'); });
        $('attachImage').addEventListener('click', () => $('imageInput').click());
        $('attachAudio').addEventListener('click', () => $('audioInput').click());
        $('attachDocument').addEventListener('click', () => $('documentInput').click());
        $('cameraInput').addEventListener('change', e => { if (e.target.files[0]) handleFileSelect(e.target.files[0], 'image'); e.target.value = ''; });
        $('imageInput').addEventListener('change', e => { if (e.target.files[0]) handleFileSelect(e.target.files[0], 'image'); e.target.value = ''; });
        $('audioInput').addEventListener('change', e => { if (e.target.files[0]) handleFileSelect(e.target.files[0], 'audio'); e.target.value = ''; });
        $('documentInput').addEventListener('change', e => { if (e.target.files[0]) handleFileSelect(e.target.files[0], 'document'); e.target.value = ''; });
        $('previewClose').addEventListener('click', () => { pendingMedia = null; $('previewContainer').classList.remove('show'); });

        // Recording
        $('micBtn').addEventListener('click', async () => {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    let mimeType = 'audio/webm';
                    if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';
                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: mimeType });
                        const url = URL.createObjectURL(blob);
                        $('previewContent').innerHTML = `<div style="display:flex;flex-direction:column;gap:12px;"><audio controls src="${url}" style="width:100%;"></audio><div style="display:flex;gap:10px;justify-content:center;"><button id="sendAudio" class="modal-btn primary">Enviar</button><button id="discardAudio" class="modal-btn cancel">Descartar</button></div></div>`;
                        $('previewContainer').classList.add('show');
                        const reader = new FileReader();
                        reader.onload = () => { pendingMedia = { type: 'audio', data: reader.result.split(',')[1], mimetype: mimeType }; };
                        reader.readAsDataURL(blob);
                        $('sendAudio').onclick = () => { if (pendingMedia) socket.emit('send-message', { accountId: currentAccountId, jid: currentChat, text: '', type: 'audio', media: pendingMedia.data, mimetype: pendingMedia.mimetype }); URL.revokeObjectURL(url); };
                        $('discardAudio').onclick = () => { URL.revokeObjectURL(url); pendingMedia = null; $('previewContainer').classList.remove('show'); };
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    recordingSeconds = 0;
                    $('micBtn').classList.add('recording');
                    messageInput.style.display = 'none';
                    $('recordingIndicator').classList.add('show');
                    recordingTimer = setInterval(() => {
                        recordingSeconds++;
                        $('recordingTime').textContent = `${Math.floor(recordingSeconds / 60)}:${(recordingSeconds % 60).toString().padStart(2, '0')}`;
                    }, 1000);
                } catch (err) { alert('Erro: ' + err.message); }
            } else {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(t => t.stop());
                isRecording = false;
                $('micBtn').classList.remove('recording');
                messageInput.style.display = '';
                $('recordingIndicator').classList.remove('show');
                clearInterval(recordingTimer);
            }
        });

        $('cancelRecordingBtn').addEventListener('click', () => {
            if (mediaRecorder) {
                mediaRecorder.stream.getTracks().forEach(t => t.stop());
                isRecording = false;
                $('micBtn').classList.remove('recording');
                messageInput.style.display = '';
                $('recordingIndicator').classList.remove('show');
                clearInterval(recordingTimer);
            }
        });

        // Profile
        headerAvatar.addEventListener('click', () => {
            if (currentChat && currentContactInfo) {
                const { name, profilePic, phoneNumber } = currentContactInfo;
                $('profileAvatar').innerHTML = profilePic ? `<img src="${profilePic}" style="width:100%;height:100%;object-fit:cover;">` : name.charAt(0).toUpperCase();
                $('profileName').textContent = name;
                let formatted = '+' + phoneNumber;
                if (phoneNumber.startsWith('55') && phoneNumber.length >= 12) {
                    formatted = `+55 (${phoneNumber.slice(2,4)}) ${phoneNumber.slice(4,9)}-${phoneNumber.slice(9)}`;
                }
                $('profileNumber').textContent = formatted;
                $('profileModal').classList.add('show');
            }
        });
        $('profileClose').addEventListener('click', () => $('profileModal').classList.remove('show'));
        $('profileCopy').addEventListener('click', () => {
            if (currentContactInfo) {
                navigator.clipboard.writeText(currentContactInfo.phoneNumber).then(() => {
                    $('profileCopy').textContent = 'Copiado!';
                    setTimeout(() => $('profileCopy').textContent = 'Copiar n√∫mero', 2000);
                });
            }
        });
        $('profileModal').addEventListener('click', e => { if (e.target === $('profileModal')) $('profileModal').classList.remove('show'); });

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        init();
    </script>
</body>
</html>
